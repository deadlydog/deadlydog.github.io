<script>
function InitializeLightOrDarkModeStylesheet() {
	let storageKey = 'theme-preference';
	let darkHref = '{{ '/assets/css/dark.css' | relative_url }}';
	let systemQuery = window.matchMedia('(prefers-color-scheme: dark)');
	let stored = null;
	let mode = 'system';

	try
	{
		stored = localStorage.getItem(storageKey);
		if (stored === 'dark' || stored === 'light')
		{
			mode = stored;
		}
	}
	catch (error)
	{
		console.warn('Could not access localStorage to get theme preference:', error);
		mode = 'system';
	}

	let theme = mode === 'system' ? (systemQuery.matches ? 'dark' : 'light') : mode;
	let linkMedia = mode === 'system' ? '(prefers-color-scheme: dark)' : (theme === 'dark' ? 'all' : 'not all');
	let docEl = document.documentElement;

	docEl.dataset.theme = theme;
	docEl.dataset.themeMode = mode;

	// Need to define colors here (in addition to the colorScheme) to prevent a flash of incorrect colors on each initial page load.
	// So we need to keep these colors in sync with the ones defined in ThemeToggle.js.
	if (theme === 'dark')
	{
		docEl.style.backgroundColor = '#0f172a';
		docEl.style.color = '#e5e7eb';
		docEl.style.colorScheme = 'dark';
	}
	else
	{
		docEl.style.backgroundColor = '#ffffff';
		docEl.style.color = '#111827';
		docEl.style.colorScheme = 'light';
	}

	let darkStylesheet = document.getElementById('theme-dark');

	if (!darkStylesheet)
	{
		darkStylesheet = document.createElement('link');
		darkStylesheet.id = 'theme-dark';
		darkStylesheet.rel = 'stylesheet';
		darkStylesheet.href = darkHref;
		document.head.appendChild(darkStylesheet);
	}

	darkStylesheet.media = linkMedia;
}
InitializeLightOrDarkModeStylesheet();
</script>
